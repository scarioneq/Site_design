{% extends 'base.html' %}

{% block content %}
<h1>Панель администратора</h1>

<nav>
    <a href="{% url 'manage_categories' %}">Управление категориями</a>
    <a href="/superadmin/">Django админка</a>
    <a href="{% url 'index' %}">На главную</a>
</nav>

<h2>Все заявки</h2>

<form method="get">
    <div>
        <label>Фильтр по статусу:</label>
        <select name="status" onchange="this.form.submit()">
            <option value="">Все заявки</option>
            {% for status_value, status_label in status_choices %}
                <option value="{{ status_value }}" {% if request.GET.status == status_value %}selected{% endif %}>
                    {{ status_label }}
                </option>
            {% endfor %}
        </select>
    </div>
</form>

{% if applications %}
    <table border="1">
        <thead>
            <tr>
                <th>Дата создания</th>
                <th>Пользователь</th>
                <th>Название</th>
                <th>Категория</th>
                <th>Статус</th>
                <th>Фото</th>  <!-- ← ИЗМЕНИЛИ НАЗВАНИЕ -->
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            {% for app in applications %}
            <tr>
                <td>{{ app.created_at|date:"d.m.Y H:i" }}</td>
                <td>{{ app.user.full_name }}</td>
                <td>{{ app.title }}</td>
                <td>{{ app.category.name }}</td>
                <td>{{ app.get_status_display }}</td>
                <td>
                    {% if app.status == 'completed' %}
                        <div>
                            <strong>До:</strong><br>
                            {% if app.photo %}
                                <img src="{{ app.photo.url }}" alt="Помещение до" width="80" style="max-height: 80px;">
                            {% else %}
                                <span style="color: #999;">Нет фото</span>
                            {% endif %}
                        </div>
                        <div>
                            <strong>После:</strong><br>
                            {% if app.design_photo %}
                                <img src="{{ app.design_photo.url }}" alt="Дизайн после" width="80" style="max-height: 80px; border: 2px solid green;">
                            {% else %}
                                <span style="color: #999;">Нет дизайна</span>
                            {% endif %}
                        </div>
                    {% else %}
                        {% if app.photo %}
                            <img src="{{ app.photo.url }}" alt="{{ app.title }}" width="100" style="max-height: 100px;">
                            <br>
                            <small>Помещение</small>
                        {% else %}
                            <span style="color: #999;">Нет фото</span>
                        {% endif %}
                    {% endif %}
                </td>
                <td>
                    {% if app.can_change_status %}
                        {% if app.can_change_to_in_progress %}
                            <a href="{% url 'change_application_status' app.id %}">Принять в работу</a>
                        {% elif app.can_change_to_completed %}
                            <a href="{% url 'change_application_status' app.id %}">Завершить</a>
                        {% endif %}
                    {% else %}
                        <span>Статус изменен</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% else %}
    <p>Заявок нет</p>
{% endif %}
{% endblock %}